# ContactLens System Specification

## 概要
Unity用コンタクトレンズシステム。プレハブをキャラクター直下に配置することで目のテクスチャを変更し、外すと元に戻る。

## 対象プラットフォーム
- Unity

---

## 機能一覧

### 実装済み

#### コアシステム
- プレハブをキャラクター直下に配置 → 目のテクスチャ変更
- プレハブを外す → 元のテクスチャに復元

---

### 開発中

#### 1. 瞳孔Hide機能
- **目的**: 元の瞳孔メッシュを奥に移動し、コンタクトレンズのテクスチャが正しく見えるようにする
- **仕組み**: 特定のアバターにおいて、特定の独立アイランド（瞳孔）をZ方向にオフセット移動
- **アバター定義に含める情報**: 瞳孔アイランド定義、オフセット量（Editor側の責務）
- **製作者が設定する項目**: 使用有無、色、透明度（ContactLensコンポーネントで設定、実装済み）

#### 2. サムネイル作成機能
- **目的**: 製作者モードのリリース時に、レンズ適用後のプレビュー画像を自動生成する
- **トリガー**: 製作者モードでContactLensコンポーネントの「リリース」ボタン押下時
- **生成内容**: レンズを適用した顔のプレビュー
- **サイズ**: 256x256（正方形）
- **形式**: 透過PNG
- **カメラ位置**: 対象アバター定義にカメラ位置・角度を含める
- **手動差し替え**: 不可（自動生成のみ）

##### 対象アバター定義（拡張）
```
{
  名称,
  期待されるprefabパス,
  サムネイル用カメラ位置,
  サムネイル用カメラ角度
}
```

#### 3. カタログ表示・検索機能
- **目的**: Projectに存在するレンズを一覧表示し、簡単に選択できるようにする
- **アクセス方法**: 
  - メニュー「Pan/ContactLens」から
  - ContactLensコンポーネント上のボタンから
- **表示形式**: サムネイルのグリッド表示
- **検索・フィルタ**: 可能（特にアバター別フィルタ）
- **操作**: サムネイルクリック → Projectビューで該当prefabを選択状態にする

#### 4. 製作者モード
- **目的**: Unityの詳細な知識がなくても、テクスチャを作成できる人が配布用unitypackageを簡単に作成できる
- **メニュー**: Pan/ContactLens/製作者モード
- **前提条件**: 対象アバターのprefabがAssets内に存在すること（なければエラー）

##### 対象アバター定義
- 辞書形式で定義:
  - 名称
  - 期待されるprefabパス
  - サムネイル用カメラ位置
  - サムネイル用カメラ角度
  - 瞳孔アイランド定義
  - 瞳孔オフセット量
- 製作者は「このアバター向けに作成」という宣言として選択
- システム的には他のアバターでも動作可能

##### 状態管理
2種類のファイルが存在する:

**製作者モード状態ファイル（unitypackageに含めない）**
- 製作者モードかどうか
- 現在の作者名、製品名、対象アバター
- 保存場所: （要検討）

**製品設定ファイル（unitypackageに含める）**
- `res/config.json`
- 対象アバター情報など

##### 製作者が設定する項目
- 対象アバター（リストから選択）
- 作者名
- 製品名
- 各レンズごと:
  - テクスチャ画像
  - 瞳孔の使用有無
  - 使用する場合: 色、透明度

##### レンズ名
- ContactLensコンポーネントがアタッチされたGameObjectの名前がレンズ名となる

##### 出力フォルダ構造
```
Assets/
└── {作者名}/
    └── {製品名}/
        ├── {レンズ名}.prefab
        ├── ...
        └── res/
            ├── config.json
            ├── tex/
            │   ├── {レンズ名}.png
            │   └── ...
            └── tmb/
                ├── {レンズ名}.png
                └── ...
```

##### 製作者モードUI

```
┌─────────────────────────────────────────────┐
│ ContactLens 製作者モード                     │
├─────────────────────────────────────────────┤
│                                             │
│ 対象アバター: [ドロップダウン ▼]             │
│                                             │
│ 作者名: [________________]                  │
│ ┌─────────────────────────────────────────┐ │
│ │ℹ Assets直下のフォルダ名になります        │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ 製品名: [________________]                  │
│ ┌─────────────────────────────────────────┐ │
│ │ℹ 作者名フォルダ直下のフォルダ名です。     │ │
│ │  この中に複数のレンズを入れられます。     │ │
│ │  配布時の名称に合わせるといいでしょう。   │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│         [製作開始]                          │
├─────────────────────────────────────────────┤
│ リリース済みレンズ:                          │
│ ┌─────────────────────────────────────────┐ │
│ │ ・BlueSky                               │ │
│ │ ・RedMoon                               │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│   [パッケージ出力]    [終了]                │
│                                             │
└─────────────────────────────────────────────┘
```

**UI状態遷移**
- 初期状態: 対象アバター、作者名、製品名を入力 →「製作開始」ボタン
- 製作中: リリース済みレンズ一覧が表示 →「パッケージ出力」「終了」ボタンが有効

##### ワークフロー
1. メニュー「Pan/ContactLens/製作者モード」をクリック → 専用UIが開く
2. 対象アバターをリストから選択
3. 作者名・製品名を入力 → 製作者モード開始（状態ファイル作成）
4. シーン上でアバターにContactLensコンポーネントを使用し、テクスチャや瞳孔を設定
5. ContactLensコンポーネントの「リリース」ボタンを押す → サムネイル・prefab生成
6. 複数レンズを作る場合は4-5を繰り返し
7. 製作者モードUIの「パッケージ出力」ボタンでunitypackage出力
8. 製作者モードUIの「終了」ボタンで製作者モード終了（状態ファイル削除）

---

## 技術仕様

### サムネイル生成
RenderTexture → Texture2D → PNG の流れで生成する。

1. 一時的なカメラを生成し、アバター定義のカメラ位置・角度に配置
2. RenderTexture（256x256、透過対応）を作成しカメラに割り当て
3. camera.Render()で描画
4. RenderTexture.activeに設定し、Texture2D.ReadPixels()で読み取り
5. texture.EncodeToPNG()でバイト配列化
6. File.WriteAllBytes()で res/tmb/{レンズ名}.png に保存
7. 一時オブジェクトをクリーンアップ

---

## ファイル構成

（プロジェクト構成が決まれば追記）

---

作成日: 2026-02-03
更新日: 2026-02-03
